with cust(cust_numb) as (values ('3517616'), ('4284054'), ('5384728'), ('6486741'), ('4840676'), ('5464151'), ('3457324'), ('4503987'), ('3334911'), ('3555995'), ('5599024'), ('4289317'),
                     ('5883608'), ('3531967'), ('3236028'), ('5957235'), ('3425010'), ('5454215'), ('4702003'), ('3253650'), ('4277669'), ('3519632'), ('3268706'), ('3353515'),
                     ('5660457'), ('4021695'), ('4215405'), ('5145309'), ('3449067'), ('4380173'), ('4033209'), ('5262066'), ('4065950'), ('3338347'), ('3541661'), ('5341169'),
                     ('3258502'), ('5253824'), ('4915685'), ('4055774'), ('3421648'), ('4023185'), ('4408974'), ('3233717'), ('3264942'), ('5130627'), ('3455816'), ('3542018'),
                     ('6331757'), ('4305950'), ('5246717'), ('5647669'), ('3341486'), ('4464403'), ('3394179'), ('3444883'), ('4294515'), ('4047061'), ('4038302'), ('3362578'),
                     ('5228988'), ('3382501'), ('3363461'), ('3317002'), ('4260515'), ('3355586'), ('3476410'), ('3414246'), ('3476884'), ('5453966'), ('5078499'), ('3264915'),
                     ('4308715'), ('3452356'), ('3364148'), ('4754171'), ('5504867'), ('3276537'), ('7249765'), ('3363265'), ('5881496'), ('4916871'), ('5220129'), ('6624067'),
                     ('3552523'),
                     ('3416663'),
                     ('6779836'),
                     ('3561648'),
                     ('7473316'),
                     ('3342788'),
                     ('3386856'),
                     ('3457173'),
                     ('5019008'),
                     ('4241216'),
                     ('4272888'),
                     ('4776166'),
                     ('4064737'),
                     ('3316272'),
                     ('5208642'),
                     ('4795573'),
                     ('3425207'),
                     ('4234117'),
                     ('3540671'),
                     ('7136958'),
                     ('3473422'),
                     ('5690969'),
                     ('5220325'),
                     ('4612574'),
                     ('3415842'),
                     ('3427955'),
                     ('6471114'),
                     ('6510297'),
                     ('5236005'),
                     ('4148096'),
                     ('4082325'),
                     ('6644740'),
                     ('5538741'),
                     ('4002313'),
                     ('3472888'),
                     ('5280741'),
                     ('4927244'),
                     ('5428548'),
                     ('4190057'),
                     ('3312864'),
                     ('5980682'),
                     ('3345008'),
                     ('4238202'),
                     ('3450562'),
                     ('3317066'),
                     ('3431511'),
                     ('4329596'),
                     ('3358823'),
                     ('6550699'),
                     ('4973336'),
                     ('4270951'),
                     ('3327279'),
                     ('3436543'),
                     ('4798446'),
                     ('3244901'),
                     ('4022088'),
                     ('4225181'),
                     ('4148292'),
                     ('3391396'),
                     ('3289346'),
                     ('5428539'),
                     ('3312917'),
                     ('3423272'),
                     ('4026798'),
                     ('6978568'),
                     ('5680462'),
                     ('3531958'),
                     ('3554629'),
                     ('5208633'),
                     ('5298135'),
                     ('4526294'),
                     ('6896228'),
                     ('3519678'),
                     ('3254739'),
                     ('3482662'),
                     ('3515208'),
                     ('3517732'),
                     ('3377544'),
                     ('3312846'),
                     ('5092455'),
                     ('3439844'),
                     ('4263200'),
                     ('6131624'),
                     ('3466779'),
                     ('6835473'),
                     ('6108614'),
                     ('6752846'),
                     ('3428259'),
                     ('4512762'),
                     ('5193961'),
                     ('4784718'),
                     ('3312837'),
                     ('3448754'),
                     ('4168830'),
                     ('3341501'),
                     ('3363327'),
                     ('5650351'),
                     ('6110763'),
                     ('4975977'),
                     ('4346238'),
                     ('7166354'),
                     ('6299846'),
                     ('6281025'),
                     ('4026002'),
                     ('3408654'),
                     ('3336401'),
                     ('3487505'),
                     ('4971356'),
                     ('4326312'),
                     ('3396756'),
                     ('3471852'),
                     ('4545077'),
                     ('4020311'),
                     ('6568190'),
                     ('3382609'),
                     ('6682066'),
                     ('6297250'),
                     ('3291887'),
                     ('4038259'),
                     ('6628642'),
                     ('3424501'),
                     ('3476964'),
                     ('7003020'),
                     ('3428874'),
                     ('3428026'),
                     ('4229178'),
                     ('6522667'),
                     ('3368812'),
                     ('5406287'),
                     ('7045645'),
                     ('4899284'),
                     ('3357352'),
                     ('3370319'),
                     ('4670092'),
                     ('3548030'),
                     ('6625280'),
                     ('4215575'),
                     ('3297266'),
                     ('7214846'),
                     ('4384883'),
                     ('3504880'),
                     ('3565564'),
                     ('5137960'),
                     ('5449491'),
                     ('5266909'),
                     ('3402455'),
                     ('3429221'),
                     ('1686811'),
                     ('5009778'),
                     ('3441699'),
                     ('3509117'),
                     ('3493516'),
                     ('4357715'),
                     ('4290868'),
                     ('3395659'),
                     ('3523280'),
                     ('3348773'),
                     ('4311006'),
                     ('3541992'),
                     ('5538723'),
                     ('4018119'),
                     ('5917378'),
                     ('4604887'),
                     ('4405833'),
                     ('5110818'),
                     ('4384963'),
                     ('4754750'),
                     ('3385447'),
                     ('5466220'),
                     ('4540312'),
                     ('6075016'),
                     ('6442682'),
                     ('6761694'),
                     ('5619538'),
                     ('3287632'),
                     ('4210632'),
                     ('4494933'),
                     ('3343000'),
                     ('5818056'),
                     ('4797768'),
                     ('3353926'),
                     ('6569956'),
                     ('3401036'),
                     ('6223259'),
                     ('4491838'),
                     ('5042125'),
                     ('4417312'),
                     ('6314080'),
                     ('5932002'),
                     ('5300006'),
                     ('5200962'),
                     ('4982898'),
                     ('3345044'),
                     ('5758370'),
                     ('5631854'),
                     ('4304023'),
                     ('3409252'),
                     ('3235662'),
                     ('3430308'),
                     ('4009352'),
                     ('5710947'),
                     ('5257893'),
                     ('3359396'),
                     ('5553457'),
                     ('4384918'),
                     ('5092482'),
                     ('3291967'),
                     ('3406344'),
                     ('4267368'),
                     ('4071499'),
                     ('4060223'),
                     ('5090108'),
                     ('5406820'),
                     ('4554752'),
                     ('6342503'),
                     ('4126127'),
                     ('3471601'),
                     ('4599544'),
                     ('3329561'),
                     ('4667989'),
                     ('5003042'),
                     ('5086373'),
                     ('3434322'),
                     ('3361908'),
                     ('4138249'),
                     ('6567379'),
                     ('5331036'),
                     ('3382645'),
                     ('4283536'),
                     ('4180399'),
                     ('4044162'),
                     ('4106755'),
                     ('5531828'),
                     ('1540942'),
                     ('3358743'),
                     ('4582482'),
                     ('3291903'),
                     ('4011438'),
                     ('5147058'),
                     ('3414111'),
                     ('5446378'),
                     ('6072359'),
                     ('4309901'),
                     ('6339358'),
                     ('6544885'),
                     ('6104789'),
                     ('5350693'),
                     ('6283103'),
                     ('4038348'),
                     ('6299677'),
                     ('4383553'),
                     ('3388015'),
                     ('3417993'),
                     ('4495291'),
                     ('6607790'),
                     ('4005686'),
                     ('3441476'),
                     ('3386721'),
                     ('5317436'),
                     ('4573688'),
                     ('6209925'),
                     ('4712485'),
                     ('3480085'),
                     ('4065095'),
                     ('6572210'),
                     ('4447600'),
                     ('5262459'),
                     ('5028212'),
                     ('4064755'),
                     ('4049407'),
                     ('4881872'),
                     ('5414857'),
                     ('7145617'),
                     ('4251375'),
                     ('4606769'),
                     ('3381272'),
                     ('6401734'),
                     ('3523388'),
                     ('5109544'),
                     ('6378458'),
                     ('4245150'),
                     ('5063058'),
                     ('4380244'),
                     ('5225589'),
                     ('3343037'),
                     ('4369613'),
                     ('3523681'),
                     ('6939646'),
                     ('4076573'),
                     ('4210945'),
                     ('4346345'),
                     ('3371327'),
                     ('6570542'),
                     ('3358191'),
                     ('3235528'),
                     ('3565626'),
                     ('5929757'),
                     ('7099944'),
                     ('0755855'),
                     ('6480300'),
                     ('4037296'),
                     ('7256685'),
                     ('4856409'),
                     ('3316548'),
                     ('3371942'),
                     ('3386151'),
                     ('5322206'),
                     ('5502636'),
                     ('4818754'),
                     ('6337341'),
                     ('4961955'),
                     ('5410717'),
                     ('0613642'),
                     ('3521497'),
                     ('4702147'),
                     ('6384398'),
                     ('3455601'),
                     ('4510032'),
                     ('4263166'),
                     ('4509053'),
                     ('3401107'),
                     ('3504853'),
                     ('6104823'),
                     ('3472343'),
                     ('4192144'),
                     ('7466182'),
                     ('5750760'),
                     ('3477044'),
                     ('2213660'),
                     ('4059351'),
                     ('3473440'),
                     ('4027779'),
                     ('5788169'),
                     ('5524603'),
                     ('4944154'),
                     ('6238911'),
                     ('3362676'),
                     ('6487401'),
                     ('4223156'),
                     ('5539713'),
                     ('3233682'),
                     ('7320981'),
                     ('4327124'),
                     ('3295419'),
                     ('4197728'),
                     ('7421168'),
                     ('5648828'),
                     ('3554530'),
                     ('4806589'),
                     ('4963828'),
                     ('4329550'),
                     ('3344376'),
                     ('5025331'),
                     ('2199784'),
                     ('4071587'))
SELECT op.cust_numb,
	op.full_name,
	op.cat,	
-- 	op.code,
	op.bc,
	op.act,
    op.charge_amount,
	op.pay_amount
FROM (SELECT --sum(tr.amount),
			cu.full_name,
			cat."name" cat,	
			--tt.code,
			bc."name" bc,
			act."name" act,
			cu.customer_number cust_numb,
			sum(CASE tt.code WHEN '001' THEN
		            tr.amount
			    END) charge_amount,
            sum(CASE tt.code WHEN '003' THEN
		            tr.amount
			    END) pay_amount
	FROM prx_transaction tr
	JOIN prx_customer cu ON tr.customer_id = cu.id
	join cust c on cu.customer_number = c.cust_numb
	JOIN prx_business_center bc ON bc.id = cu.business_center_id  
	LEFT JOIN prx_activity act ON act.id = cu.activity_id 
	JOIN prx_customer_category cat ON cat.id = cu.category_id  
	JOIN prx_transaction_type_combinati ttc ON ttc.id = tr.trans_type_combination_id  AND ttc.deleted_by IS null
	JOIN prx_transaction_type tt ON tt.id = ttc.transaction_type_id and tt.deleted_by IS null
	join prx_transaction_sub_type tst on tst.id = ttc.transaction_sub_type_id and ttc.deleted_by  is null
	WHERE  case tt.code WHEN '001' THEN tr.created_date  BETWEEN  '01-oct-2023' AND date_trunc('month','01-oct-2023'::date ) + INTERVAL '1 month' - INTERVAL '1 day'
					WHEN '003' THEN tr.created_date BETWEEN '01-nov-2023' AND now()::date
			END
		AND cat.code IN ('C248','C257','C37','C256','C258')  AND (tt.code = '001' OR tt.code ='003')
	/*AND tr.customer_id ='00052c86-9e51-fcc8-a3bc-5ef721fbaf75'*/ --AND cu.customer_number ='1592538'
        --and tr.account_type_id='c425684a-1695-fca4-b245-73192da9a52e' --თელმიკოს კონტრაქტი
		GROUP BY cu.full_name,
			cat."name",
-- 			tt.code,
			bc."name",
			act."name",
			cu.customer_number) op;


/*დეპოზიტი*/
/*4a431bec-24cd-c871-b54d-3ef9ffe1eecb გადახდა დეპოზიტი

d58817da-ff77-3139-e19a-d29bc2192635 დარიცხვა დეპოზიტის დარიცხვა*/

dep_cust(dep_cust) as (select cu.customer_number
                       from prx_customer cu
                       join prx_customer_contract cuco on cu.id = cuco.customer_id and cuco.deleted_by is null
                       join cust c on c.cust_numb = cu.customer_number
                       where cuco.type_id = '3aeea7c5-6a36-a898-bc82-5a3923c6e9f9' /*დეპოზიტი*/),
dep_charge(dep_cust_charge) as (SELECT cu.customer_number,
                                       sum(tr.amount) over (partition by tr.customer_id) dep_charge_amount,
                                       tr.created_date,
                                       row_number() over (partition by tr.customer_id order by tr.created_date desc) rn
                                 FROM prx_transaction tr
                                 JOIN prx_customer cu ON tr.customer_id = cu.id
                                 join dep_cust dc on cu.customer_number = dc.dep_cust
                                 JOIN prx_customer_category cat ON cat.id = cu.category_id
                                 WHERE tr.created_date BETWEEN '01-jul-2021' AND now()::date
                                       AND cat.code IN ('C248', 'C257', 'C37', 'C256', 'C258')
                                       AND tr.trans_type_combination_id = 'd58817da-ff77-3139-e19a-d29bc2192635'
                                        and tr.deleted_by is null
                                 /*GROUP BY cu.customer_number,
                                          tr.customer_id,
                                          tr.created_date*/),
dep_pay (dep_cust_pay) as (SELECT cu.customer_number,
                                  sum(tr.amount) over (partition by tr.customer_id)    dep_pay_amount,
                                  tr.created_date,
                                  row_number() over (partition by tr.customer_id order by tr.created_date desc) rn
                                FROM prx_transaction tr
                                JOIN prx_customer cu ON tr.customer_id = cu.id
                                join dep_cust dc on cu.customer_number = dc.dep_cust
                                JOIN prx_customer_category cat ON cat.id = cu.category_id
                                WHERE  tr.created_date between '01-oct-2023' AND date_trunc('month', '01-oct-2023'::date) + INTERVAL '1 month' - INTERVAL '1 day'
                                  AND cat.code IN ('C248', 'C257', 'C37', 'C256', 'C258')
                                  AND tr.trans_type_combination_id = '4a431bec-24cd-c871-b54d-3ef9ffe1eecb'
                                    and tr.deleted_by is null
                                /*GROUP BY cu.customer_number,
                                         tr.customer_id,
                                          tr.created_date*/)

SELECT dp.dep_cust,
    ch.dep_charge_amount,
    ch.created_date,
	pa.dep_pay_amount,
	pa.created_date
FROM dep_cust dp
left join dep_charge ch on ch.dep_cust_charge = dp.dep_cust and ch.rn = 1
left join dep_pay pa on pa.dep_cust_pay = dp.dep_cust and pa.rn = 1;


/*prx*/
--deposit amount
SELECT sum(t.amount) from prx_open_transaction t
WHERE t.deleted_by is null and  t.account_type_id = '3aeea7c5-6a36-a898-bc82-5a3923c6e9f9'
    and t.customer_id =  '96396aaa-f37b-cdb5-7f9a-623c67d1c803'
group by t.customer_id;

--deposit
SELECT tr.trans_date,
         tr.aviso_date,
         tr.created_date,
        sum(tr.amount)
from prx_transaction tr
join PRX_TRANSACTION_TYPE_COMBINATI ttc on ttc.ID = tr.TRANS_TYPE_COMBINATION_ID
join PRX_TRANSACTION_TYPE tt on tt.ID = ttc.TRANSACTION_TYPE_ID
WHERE tr.deleted_by is null
  and tr.account_type_id = '3aeea7c5-6a36-a898-bc82-5a3923c6e9f9'
  and tr.customer_id = '96396aaa-f37b-cdb5-7f9a-623c67d1c803'
  and (/*tt.ID = 'd15117f5-7d9e-e6a0-bda6-01b1f33ccb0a' or */tr.TRANS_TYPE_COMBINATION_ID = 'f6c4e8ec-aab5-a59a-f42e-d814905a3d07') --დეპოზიტის გადახდა
group by tr.trans_date,
         tr.aviso_date,
         tr.created_date;